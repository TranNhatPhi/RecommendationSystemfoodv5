<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Tư Vấn Món Ăn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* Custom animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeInUp 0.6s ease-out;
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-bottom: none;
        }

        .chat-header h4 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .chat-messages {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            min-height: 450px;
            max-height: 650px;
            overflow-y: auto;
            padding: 25px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            /* Custom scrollbar */
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .chat-input {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 0 0 20px 20px;
            padding: 25px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-top: none;
        }

        .message {
            margin-bottom: 20px;
            padding: 16px 20px;
            border-radius: 25px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.4s ease-out;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .user-message::before {
            content: '';
            position: absolute;
            top: 50%;
            right: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-left-color: #764ba2;
            transform: translateY(-50%);
        }

        .ai-message {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            color: #333;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .ai-message::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: #f8f9fa;
            transform: translateY(-50%);
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            font-style: italic;
            color: #666;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: pulse 1.5s infinite;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .customer-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideInLeft 0.6s ease-out 0.2s both;
        }

        .customer-selector h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 25px;
        }

        .customer-info-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .customer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 30px;
            padding: 14px 35px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .form-control {
            border-radius: 30px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 14px 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            background: rgba(255, 255, 255, 1);
            outline: none;
        }

        .form-select {
            border-radius: 30px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 14px 25px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            background: rgba(255, 255, 255, 1);
            outline: none;
        }

        /* Processing Workflow Visualization Styles */
        .processing-workflow {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 35px;
            margin: 30px 0;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: none;
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .processing-workflow::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: gradient-flow 3s ease infinite;
        }

        @keyframes gradient-flow {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .workflow-header {
            text-align: center;
            margin-bottom: 35px;
            position: relative;
        }

        .workflow-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .workflow-subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .workflow-progress {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            height: 12px;
            margin: 25px 0;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            height: 100%;
            border-radius: 20px;
            transition: width 0.6s ease;
            position: relative;
            overflow: hidden;
            animation: gradient-flow 2s ease infinite;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* Click indicator cho workflow steps */
        .step-item::before {
            content: '👆 Click để xem chi tiết';
            position: absolute;
            top: -8px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
            z-index: 10;
            pointer-events: none;
        }

        .step-item:hover::before {
            opacity: 1;
            transform: translateY(0);
        }

        .step-item.expanded::before {
            content: '👆 Click để thu gọn';
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        /* Enhanced workflow steps container */
        .workflow-steps {
            display: grid;
            gap: 15px;
            position: relative;
        }

        .workflow-steps::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #28a745 100%);
            opacity: 0.3;
            z-index: 1;
        }

        .step-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 0;
            border-left: 4px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .step-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            border-left-color: #667eea;
        }

        .step-item.pending {
            border-left-color: #dee2e6;
            color: #6c757d;
        }

        .step-item.active {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%);
            animation: pulse 2s infinite;
        }

        .step-item.completed {
            border-left-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }

        .step-item.error {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
            }

            50% {
                box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4);
            }

            100% {
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
            }
        }

        .step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            position: relative;
            border-bottom: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .step-header:hover {
            background: rgba(102, 126, 234, 0.05);
            border-bottom-color: rgba(102, 126, 234, 0.2);
        }

        .step-header::after {
            content: '▼';
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.3s ease;
            color: #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(102, 126, 234, 0.1);
        }

        .step-item.collapsed .step-header::after {
            transform: rotate(-90deg);
            content: '▶';
        }

        .step-title {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .step-description {
            font-size: 13px;
            color: #7f8c8d;
            margin: 0;
        }

        .step-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step-status.pending {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .step-status.active {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            animation: blink 1.5s infinite;
        }

        .step-status.completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .step-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b2b7;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.7;
            }
        }

        .step-item.collapsed .step-header::after {
            transform: rotate(-90deg);
        }

        .step-details {
            padding: 0;
            display: none;
            border-top: 1px solid #f0f0f0;
            margin-top: 0;
            background: rgba(248, 249, 250, 0.8);
            backdrop-filter: blur(5px);
        }

        .step-item.expanded .step-details {
            display: block;
            animation: slideDown 0.4s ease-out;
            padding: 20px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                max-height: 800px;
                transform: translateY(0);
            }
        }

        .step-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .step-analysis {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .analysis-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .analysis-section:hover {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .analysis-section h6 {
            color: #495057;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-section h6::before {
            content: '';
            width: 3px;
            height: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .technique-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .technique-tag {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(21, 101, 192, 0.2);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .technique-tag:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
            transform: scale(1.05);
        }

        .output-preview {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #2e7d32;
            line-height: 1.4;
            position: relative;
            overflow: hidden;
        }

        .output-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4caf50, transparent);
            animation: scan 2s infinite;
        }

        @keyframes scan {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Enhanced completion animations */
        @keyframes stepComplete {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
            }
        }

        .step-item.completed {
            animation: stepComplete 0.6s ease-out;
        }

        /* Progress percentage display */
        .step-status.active {
            min-width: 80px;
            text-align: center;
        }

        /* Workflow completion styles */
        .workflow-completion {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border: 2px solid #28a745;
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }

        .completion-icon {
            font-size: 3rem;
            color: #28a745;
            margin-bottom: 15px;
            animation: bounce 1s ease infinite alternate;
        }

        @keyframes bounce {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-10px);
            }
        }

        .completion-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #155724;
            margin-bottom: 10px;
        }

        .completion-message {
            color: #155724;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.2);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #155724;
            font-weight: 500;
        }

        /* Enhanced food cards styles */
        /* Food Cards Display System */
        .food-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 0;
        }

        .food-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            transition: all 0.4s ease;
            position: relative;
            animation: fadeInUp 0.6s ease-out;
        }

        .food-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .food-card-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .food-card-image::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .food-card:hover .food-card-image::after {
            left: 100%;
        }

        .food-card-content {
            padding: 20px;
        }

        .food-card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .food-card-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .nutrition-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.85rem;
        }

        .nutrition-label {
            color: #667eea;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        .nutrition-value {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 2px;
        }

        .food-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 15px 0;
        }

        .food-tag {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: lowercase;
        }

        .food-tag.healthy {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
        }

        .food-tag.protein {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
        }

        .food-tag.traditional {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #7b1fa2;
        }

        .food-card-price {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
        }

        .price-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #28a745;
        }

        .order-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        /* Chat History Panel */
        .chat-history-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .chat-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .chat-history-title {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-history-list {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
        }

        .chat-history-list::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history-list::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .history-item {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .history-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
            transform: translateX(5px);
        }

        .history-item-question {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .history-item-time {
            font-size: 0.75rem;
            color: #666;
        }

        .btn-history-toggle {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-history-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }

        .btn-clear-history {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-clear-history:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            font-weight: 600;
            font-size: 0.9rem;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="chat-container">
            <!-- Customer Selection Panel -->
            <div class="customer-selector">
                <h2 class="text-center mb-4">
                    <i class="fas fa-robot text-primary"></i>
                    AI Agent Tư Vấn Món Ăn
                </h2>
                <div class="row">
                    <div class="col-md-8">
                        <label for="customerSelect" class="form-label">Chọn khách hàng:</label>
                        <select class="form-select" id="customerSelect">
                            <option value="">-- Chọn khách hàng --</option> {% for customer_id in customer_ids %}
                            <option value="{{ customer_id }}">
                                ID: {{ customer_id }}
                                {% if customers_info.get(customer_id) %}
                                - {{ customers_info[customer_id].get('name', 'N/A') }}
                                ({{ customers_info[customer_id].get('age', 'N/A') }} tuổi)
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" onclick="loadCustomerInfo()">
                            <i class="fas fa-user-check"></i> Tải thông tin
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat History Panel -->
            <div class="chat-history-panel" id="chatHistoryPanel">
                <div class="chat-history-header">
                    <div class="chat-history-title">
                        <i class="fas fa-history"></i> Lịch sử chat
                    </div>
                    <div>
                        <button class="btn-clear-history" onclick="clearChatHistory()" title="Xóa lịch sử">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                </div>
                <div class="chat-history-list" id="chatHistoryList">
                    <div style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                        Chưa có lịch sử chat nào
                    </div>
                </div>
            </div>

            <!-- Customer Info Panel -->
            <div class="customer-info-panel" id="customerInfoPanel">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="customer-avatar" id="customerAvatar">?</div>
                    </div>
                    <div class="col">
                        <h5 class="mb-1" id="customerName">Tên khách hàng</h5>
                        <p class="mb-0 text-muted" id="customerDetails">Chi tiết khách hàng</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-primary btn-sm" onclick="clearCustomerSelection()">
                            <i class="fas fa-times"></i> Đổi khách hàng
                        </button>
                        <button class="btn-history-toggle btn-sm ms-2" onclick="toggleChatHistory()">
                            <i class="fas fa-history"></i> Lịch sử
                        </button>
                    </div>
                </div>
            </div>

            <!-- Processing Workflow Visualization -->
            <div class="processing-workflow" id="processingWorkflow">
                <div class="workflow-header">
                    <div class="workflow-title">
                        <i class="fas fa-cogs"></i> Quy trình xử lý AI Agent
                    </div>
                    <div class="workflow-subtitle">
                        Theo dõi từng bước xử lý và phân tích của hệ thống AI
                    </div>
                    <div
                        style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px; padding: 12px; margin-top: 15px; border-left: 4px solid #2196f3;">
                        <div style="color: #1565c0; font-weight: 600; font-size: 14px; margin-bottom: 5px;">
                            <i class="fas fa-info-circle"></i> Workflow AI Agent - Chi tiết đầy đủ
                        </div>
                        <div style="color: #1976d2; font-size: 13px;">
                            <strong>Workflow hiển thị đầy đủ</strong> input/output chi tiết của từng bước xử lý AI.
                            <strong>Click để thu gọn/mở rộng</strong> nếu cần.
                        </div>
                    </div>
                </div>

                <div class="workflow-progress">
                    <div class="progress-bar" id="workflowProgressBar" style="width: 0%"></div>
                </div>

                <div class="workflow-steps" id="workflowSteps">
                    <!-- Steps will be populated by JavaScript -->
                </div>

                <div class="workflow-completion" id="workflowCompletion">
                    <div class="completion-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="completion-title">Xử lý hoàn tất!</div>
                    <div class="completion-message">
                        AI Agent đã phân tích thành công và tạo ra gợi ý phù hợp cho khách hàng.
                    </div>

                    <div class="performance-metrics" id="performanceMetrics">
                        <!-- Metrics will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-header">
                <h4 class="mb-0">
                    <i class="fas fa-comments text-primary"></i>
                    Trò chuyện với AI Agent
                </h4>
                <small class="text-muted">Hỏi về món ăn, dinh dưỡng, hoặc nhận gợi ý cá nhân hóa</small>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="ai-message">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <div
                                style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
                                <i class="fas fa-robot"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <strong style="color: #667eea;">AI Agent Tư Vấn</strong>
                                <small class="text-muted ms-2">• Đang chờ</small>
                            </div>
                            <div>
                                Xin chào! 👋 Tôi là AI Agent tư vấn món ăn thông minh. Hãy chọn khách hàng ở trên và bắt
                                đầu trò chuyện với tôi nhé!
                                <br><br>
                                <div class="d-flex flex-wrap gap-2 mt-3">
                                    <span class="badge"
                                        style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1565c0; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-utensils me-1"></i>Gợi ý món ăn
                                    </span>
                                    <span class="badge"
                                        style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); color: #2e7d32; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-leaf me-1"></i>Tư vấn dinh dưỡng
                                    </span>
                                    <span class="badge"
                                        style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #e65100; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-heart me-1"></i>Phân tích sở thích
                                    </span>
                                    <span class="badge"
                                        style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); color: #7b1fa2; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-calendar-alt me-1"></i>Thực đơn cá nhân
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <i class="fas fa-robot me-2"></i>
                AI Agent đang suy nghĩ...
                <div class="loading-spinner ms-2"></div>
            </div>
            <div class="chat-input">
                <div class="row align-items-center">
                    <div class="col">
                        <input type="text" class="form-control" id="messageInput"
                            placeholder="💬 Nhập tin nhắn của bạn... (ví dụ: Tư vấn món ăn healthy)"
                            onkeypress="handleKeyPress(event)">
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-primary btn-send" onclick="sendMessage()"
                            title="Gửi tin nhắn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col text-center">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Gợi ý:</strong> "Tư vấn món ăn healthy", "Món ăn cho người tiểu đường", "Thực đơn
                            giảm cân"
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCustomerId = null;
        let isProcessing = false;        // Workflow configuration với chi tiết mở rộng
        const WORKFLOW_STEPS = [
            {
                id: 'input_analysis',
                title: '🔍 Phân tích đầu vào',
                description: 'Xử lý và phân tích câu hỏi của người dùng',
                duration: 800,
                purpose: 'Phân tích câu hỏi người dùng bằng xử lý ngôn ngữ tự nhiên để hiểu ý định và trích xuất thông tin quan trọng',
                techniques: ['Natural Language Processing', 'Intent Recognition', 'Entity Extraction', 'Sentiment Analysis'],
                input: 'Câu hỏi/yêu cầu từ người dùng',
                output: 'Intent, entities, sentiment và structured data',
                details: 'Sử dụng mô hình NLP để tokenize, phân tích cú pháp và xác định ý định của người dùng'
            },
            {
                id: 'customer_profile',
                title: '👤 Tải thông tin khách hàng',
                description: 'Truy xuất hồ sơ và lịch sử tương tác của khách hàng',
                duration: 1000,
                purpose: 'Lấy thông tin chi tiết về khách hàng để cá nhân hóa recommendations',
                techniques: ['Database Query', 'Profile Matching', 'Preference Analysis', 'History Tracking'],
                input: 'Customer ID và user context',
                output: 'Customer profile, preferences, restrictions, order history',
                details: 'Truy vấn database để lấy thông tin cá nhân, sở thích, hạn chế và lịch sử đặt hàng'
            },
            {
                id: 'semantic_search',
                title: '🔎 Tìm kiếm ngữ nghĩa',
                description: 'Tìm kiếm thông tin liên quan trong cơ sở dữ liệu',
                duration: 1200,
                purpose: 'Tìm kiếm các món ăn và thông tin liên quan dựa trên semantic similarity',
                techniques: ['Vector Search', 'Semantic Similarity', 'Content Filtering', 'Ranking Algorithm'],
                input: 'Processed query và customer preferences',
                output: 'Relevant food items, nutritional info, recipes',
                details: 'Sử dụng vector embeddings để tìm kiếm semantic similarity trong database món ăn'
            },
            {
                id: 'ai_reasoning',
                title: '🧠 Suy luận AI',
                description: 'Xử lý logic và tạo ra câu trả lời thông minh',
                duration: 1500,
                purpose: 'Áp dụng logic AI để phân tích và đưa ra quyết định thông minh',
                techniques: ['Machine Learning', 'Rule-based Reasoning', 'Collaborative Filtering', 'Content Analysis'],
                input: 'Search results, customer profile, business rules',
                output: 'Scored recommendations với reasoning explanations',
                details: 'Kết hợp ML models với business logic để tạo ra recommendations có giải thích'
            },
            {
                id: 'recommendation_generation',
                title: '⚡ Tạo gợi ý',
                description: 'Sinh ra các gợi ý cá nhân hóa cho khách hàng',
                duration: 1000,
                purpose: 'Tạo ra danh sách gợi ý món ăn được cá nhân hóa và tối ưu',
                techniques: ['Personalization Engine', 'Recommendation Ranking', 'Diversity Optimization', 'Business Rules'],
                input: 'AI reasoning results, personalization factors',
                output: 'Ranked list of personalized food recommendations',
                details: 'Áp dụng personalization algorithms để tạo ra top-N recommendations phù hợp nhất'
            },
            {
                id: 'response_formatting',
                title: '📝 Định dạng phản hồi',
                description: 'Tối ưu hóa và định dạng câu trả lời cuối cùng',
                duration: 500,
                purpose: 'Định dạng và tối ưu hóa response để hiển thị thân thiện với người dùng',
                techniques: ['Response Templating', 'Content Optimization', 'UI/UX Enhancement', 'Error Handling'],
                input: 'Generated recommendations, customer context',
                output: 'Formatted response với rich content và UI elements',
                details: 'Tạo response có cấu trúc tốt với hình ảnh, nutrition info và call-to-action'
            }
        ];

        function loadCustomerInfo() {
            const customerSelect = document.getElementById('customerSelect');
            const selectedCustomerId = customerSelect.value;

            if (!selectedCustomerId) {
                alert('Vui lòng chọn một khách hàng!');
                return;
            }

            currentCustomerId = selectedCustomerId;

            // Show customer info panel
            const customerInfoPanel = document.getElementById('customerInfoPanel');
            const customerAvatar = document.getElementById('customerAvatar');
            const customerName = document.getElementById('customerName');
            const customerDetails = document.getElementById('customerDetails');

            // Get customer info from the select option text
            const selectedOption = customerSelect.options[customerSelect.selectedIndex];
            const optionText = selectedOption.text;

            // Extract customer info
            const customerId = selectedCustomerId;
            customerAvatar.textContent = customerId.toString().substr(-2);
            customerName.textContent = `Khách hàng #${customerId}`;
            customerDetails.textContent = optionText.substring(optionText.indexOf('-') + 1).trim();

            customerInfoPanel.style.display = 'block';

            // Add welcome message
            addMessage('ai', `Xin chào! Tôi đã tải thông tin cho khách hàng #${customerId}. Bạn có thể hỏi tôi về gợi ý món ăn, dinh dưỡng, hoặc bất kỳ điều gì liên quan đến ẩm thực. Tôi sẽ đưa ra lời khuyên cá nhân hóa dựa trên hồ sơ của khách hàng này.`);
        } function clearCustomerSelection() {
            currentCustomerId = null;
            document.getElementById('customerSelect').value = '';
            document.getElementById('customerInfoPanel').style.display = 'none';

            // Reset chat with enhanced welcome message
            document.getElementById('chatMessages').innerHTML = `
                <div class="ai-message">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
                                <i class="fas fa-robot"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <strong style="color: #667eea;">AI Agent Tư Vấn</strong>
                                <small class="text-muted ms-2">• Đã reset</small>
                            </div>
                            <div>
                                Đã xóa thông tin khách hàng! 🔄 Hãy chọn khách hàng mới và bắt đầu trò chuyện nhé.
                                <br><br>
                                <div class="d-flex flex-wrap gap-2 mt-3">
                                    <span class="badge" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1565c0; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-utensils me-1"></i>Gợi ý món ăn
                                    </span>
                                    <span class="badge" style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); color: #2e7d32; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-leaf me-1"></i>Tư vấn dinh dưỡng
                                    </span>
                                    <span class="badge" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #e65100; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-heart me-1"></i>Phân tích sở thích
                                    </span>
                                    <span class="badge" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); color: #7b1fa2; padding: 8px 12px; border-radius: 15px;">
                                        <i class="fas fa-calendar-alt me-1"></i>Thực đơn cá nhân
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Hide workflow if showing
            document.getElementById('processingWorkflow').style.display = 'none';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            if (isProcessing) return;

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            if (!currentCustomerId) {
                alert('Vui lòng chọn khách hàng trước khi gửi tin nhắn!');
                return;
            }            // Add user message
            addMessage('user', message);
            messageInput.value = '';

            // Save to chat history
            saveChatHistory(message);

            // Show processing workflow
            showProcessingSteps();

            // Show typing indicator
            showTypingIndicator();
            isProcessing = true;

            try {
                // Start workflow processing
                await processStepsSequentially();
                // Send message to Enhanced AI Agent
                const response = await fetch('/api/enhanced-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        customer_id: currentCustomerId,
                        location: getCurrentLocation() // Optional location for Google Maps
                    })
                }); if (response.ok) {
                    const data = await response.json();
                    hideTypingIndicator();

                    // Add AI response with enhanced formatting and food cards
                    let aiResponse = data.response;
                    if (data.agent_type === 'enhanced') {
                        aiResponse += `\n\n<small class="text-muted">
                            <i class="fas fa-robot me-1"></i>Powered by Enhanced AI Agent
                            ${data.location_context ? ` | 📍 ${data.location_context}` : ''}
                        </small>`;
                    }

                    // Format food recommendations as cards
                    const formattedResponse = formatFoodRecommendations(aiResponse);
                    addMessage('ai', formattedResponse);

                    // Update processing steps with real API data
                    updateProcessingStepsFromResponse(data);

                    completeProcessing();
                } else {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage('ai', 'Xin lỗi, có lỗi xảy ra khi xử lý yêu cầu của bạn. Vui lòng thử lại sau.');
                showProcessingError();
            }

            isProcessing = false;
        } function addMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'message user-message' : 'message ai-message';

            const timestamp = new Date().toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            if (sender === 'ai') {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                                <i class="fas fa-robot"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">                            <div class="mb-2">
                                <strong style="color: #667eea;">AI Agent</strong>
                                <small class="text-muted ms-2">• ${timestamp}</small>
                            </div>
                            <div>${message}</div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start justify-content-end">
                        <div class="flex-grow-1 text-end me-3">
                            <div class="mb-2">
                                <strong style="color: white;">Bạn</strong>
                                <small style="color: rgba(255,255,255,0.8);" class="ms-2">• ${timestamp}</small>
                            </div>
                            <div>${message}</div>
                        </div>
                        <div>
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Add smooth scroll animation
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(20px)';
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.3s ease';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 100);
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // Processing Workflow Functions
        function showProcessingSteps() {
            const workflowContainer = document.getElementById('processingWorkflow');
            const stepsContainer = document.getElementById('workflowSteps');
            const progressBar = document.getElementById('workflowProgressBar');

            // Reset progress
            progressBar.style.width = '0%';

            // Create step elements
            stepsContainer.innerHTML = '';
            WORKFLOW_STEPS.forEach(step => {
                const stepElement = createStepElement(step);
                stepsContainer.appendChild(stepElement);
            });

            // Show workflow
            workflowContainer.style.display = 'block';

            // Scroll to workflow
            workflowContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } function createStepElement(step) {
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-item pending expanded'; // Always start expanded
            stepDiv.id = `step-${step.id}`;

            stepDiv.innerHTML = `
                <div class="step-header" onclick="toggleStepDetails('${step.id}')">
                    <div style="flex: 1;">
                        <div class="step-title">${step.title}</div>
                        <div class="step-description">${step.description}</div>
                    </div>
                    <div class="step-status pending">Đang chờ</div>
                </div>
                <div class="step-details" id="details-${step.id}" style="display: block; padding: 20px;">
                    <div class="step-analysis">
                        <div class="analysis-section">
                            <h6>🎯 Mục đích & Chức năng</h6>
                            <p style="font-size: 13px; margin: 0; color: #555; line-height: 1.5;">${step.purpose}</p>
                            
                            <h6 style="margin-top: 16px;">📥 Dữ liệu đầu vào</h6>
                            <div class="output-preview" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-color: #ff9800; color: #e65100;">
                                ${step.input}
                            </div>
                        </div>
                        <div class="analysis-section">
                            <h6>🔧 Kỹ thuật & Công nghệ</h6>
                            <div class="technique-tags">
                                ${step.techniques.map(tech => `<span class="technique-tag">${tech}</span>`).join('')}
                            </div>
                            
                            <h6 style="margin-top: 16px;">📤 Kết quả đầu ra</h6>
                            <div class="output-preview">
                                ${step.output}
                            </div>
                        </div>
                    </div>
                    <div class="technical-details">
                        <h6>💡 Chi tiết kỹ thuật & Triển khai</h6>
                        <p>${step.details}</p>
                    </div>
                    
                    <!-- Real-time Processing Status -->
                    <div class="processing-status" id="processing-${step.id}" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border-left: 4px solid #6c757d;">
                        <h6 style="color: #495057; margin-bottom: 10px;">⚙️ Trạng thái xử lý</h6>
                        <div id="status-detail-${step.id}" style="font-size: 13px; color: #6c757d;">
                            Chờ khởi động...
                        </div>
                    </div>
                    
                    <!-- Output Results -->
                    <div class="step-output" id="output-${step.id}" style="margin-top: 20px;"></div>
                </div>
            `;

            return stepDiv;
        }

        // Function để toggle step details
        function toggleStepDetails(stepId) {
            const stepElement = document.getElementById(`step-${stepId}`);
            const isExpanded = stepElement.classList.contains('expanded');

            if (isExpanded) {
                stepElement.classList.remove('expanded');
                stepElement.classList.add('collapsed');
            } else {
                stepElement.classList.remove('collapsed');
                stepElement.classList.add('expanded');
            }
        }

        async function processStepsSequentially() {
            const totalSteps = WORKFLOW_STEPS.length;

            for (let i = 0; i < totalSteps; i++) {
                const step = WORKFLOW_STEPS[i];
                await simulateStepProcessing(step, i, totalSteps);
            }
        } async function simulateStepProcessing(step, stepIndex, totalSteps) {
            const stepElement = document.getElementById(`step-${step.id}`);
            const statusElement = stepElement.querySelector('.step-status');
            const outputElement = document.getElementById(`output-${step.id}`);
            const processingStatusElement = document.getElementById(`processing-${step.id}`);
            const statusDetailElement = document.getElementById(`status-detail-${step.id}`);
            const progressBar = document.getElementById('workflowProgressBar');

            // Update step to active (always expanded)
            stepElement.className = 'step-item active expanded';
            statusElement.className = 'step-status active';
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Khởi động...';

            // Update processing status section
            processingStatusElement.style.borderLeftColor = '#ffc107';
            processingStatusElement.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
            statusDetailElement.innerHTML = '<i class="fas fa-play-circle"></i> Bắt đầu xử lý workflow step...';

            // Simulate processing time with detailed progress updates
            const processingSteps = 5;
            const detailedStatusUpdates = [
                'Khởi tạo môi trường xử lý...',
                'Tải dữ liệu và cấu hình...',
                'Thực hiện logic xử lý chính...',
                'Tối ưu hóa kết quả...',
                'Hoàn thiện và validation...'
            ];

            for (let i = 0; i < processingSteps; i++) {
                await new Promise(resolve => setTimeout(resolve, step.duration / processingSteps));

                // Update status with progress
                const progressPercent = Math.round(((i + 1) / processingSteps) * 100);
                statusElement.innerHTML = `<i class="fas fa-cog fa-spin"></i> ${progressPercent}%`;
                statusDetailElement.innerHTML = `<i class="fas fa-cogs"></i> ${detailedStatusUpdates[i]} (${progressPercent}%)`;
            }

            // Generate detailed step output with full input/output
            const output = generateDetailedStepOutput(step);
            outputElement.innerHTML = `
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border: 2px solid #28a745; border-radius: 8px; padding: 15px; margin-top: 10px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #28a745, transparent); animation: scan 1s ease-out;"></div>
                    <div style="color: #28a745; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: #28a745; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;">✓</span>
                        Xử lý hoàn thành thành công
                    </div>
                    <div style="font-size: 13px; color: #155724; line-height: 1.4;">${output}</div>
                </div>
            `;

            // Update processing status to completed
            processingStatusElement.style.borderLeftColor = '#28a745';
            processingStatusElement.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
            statusDetailElement.innerHTML = '<i class="fas fa-check-circle"></i> Hoàn thành thành công - Tất cả dữ liệu đã được xử lý';

            // Update step to completed
            stepElement.className = 'step-item completed expanded';
            statusElement.className = 'step-status completed';
            statusElement.innerHTML = '<i class="fas fa-check-circle"></i> ✓ Hoàn thành';

            // Add completion effect
            stepElement.style.borderLeftColor = '#28a745';
            stepElement.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%)';

            // Update progress bar with smooth animation
            const progress = ((stepIndex + 1) / totalSteps) * 100;
            progressBar.style.width = `${progress}%`;

            // Add completion celebration effect for final step
            if (stepIndex === totalSteps - 1) {
                setTimeout(() => {
                    const workflowContainer = document.getElementById('processingWorkflow');
                    workflowContainer.style.boxShadow = '0 8px 32px rgba(40, 167, 69, 0.3)';
                    setTimeout(() => {
                        workflowContainer.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.1)';
                    }, 1000);
                }, 200);
            }
        } function generateDetailedStepOutput(step) {
            const outputs = {
                'input_analysis': `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                            <strong>📥 INPUT ANALYSIS</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #495057;">
                                Raw Input: "${document.getElementById('messageInput')?.value || 'Tư vấn món ăn healthy'}"<br>
                                Language: Vietnamese<br>
                                Intent: food_recommendation<br>
                                Entities: [món ăn, healthy, tư vấn]<br>
                                Confidence: 0.947
                            </div>
                        </div>
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                            <strong>📤 OUTPUT RESULT</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #155724;">
                                {<br>
                                &nbsp;&nbsp;"intent": "food_recommendation",<br>
                                &nbsp;&nbsp;"entities": ["món ăn", "healthy"],<br>
                                &nbsp;&nbsp;"sentiment": "positive",<br>
                                &nbsp;&nbsp;"confidence": 0.947,<br>
                                &nbsp;&nbsp;"language": "vi",<br>
                                &nbsp;&nbsp;"processing_time": "120ms"<br>
                                }
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                        <strong>🔍 PROCESSING DETAILS:</strong><br>
                        • Tokenization: 4 tokens extracted<br>
                        • NLP Model: spaCy vi_core_news_sm<br>
                        • Intent Classification: 94.7% accuracy<br>
                        • Entity Recognition: 3 entities found<br>
                        • Sentiment Score: +0.82 (positive)
                    </div>
                `,

                'customer_profile': `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                            <strong>📥 INPUT DATA</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #495057;">
                                Customer ID: ${currentCustomerId || '1001'}<br>
                                Session Context: active<br>
                                Query Source: agent_interface<br>
                                Timestamp: ${new Date().toLocaleString()}<br>
                                Location: Tp.HCM
                            </div>
                        </div>
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                            <strong>📤 CUSTOMER PROFILE</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #155724;">
                                {<br>
                                &nbsp;&nbsp;"id": ${currentCustomerId || '1001'},<br>
                                &nbsp;&nbsp;"age": 28,<br>
                                &nbsp;&nbsp;"gender": "Male",<br>
                                &nbsp;&nbsp;"location": "Tp.HCM",<br>
                                &nbsp;&nbsp;"preferences": ["Asian", "Healthy"],<br>
                                &nbsp;&nbsp;"restrictions": [],<br>
                                &nbsp;&nbsp;"order_history": 47<br>
                                }
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                        <strong>👤 PROFILE ANALYSIS:</strong><br>
                        • Database Query: SELECT * FROM customers WHERE id=${currentCustomerId || '1001'}<br>
                        • Profile Completeness: 89% (missing dietary goals)<br>
                        • Activity Level: High (last order 2 days ago)<br>
                        • Preference Categories: Asian (78%), Healthy (65%), Fast Food (23%)<br>
                        • Average Rating Given: 4.2/5.0 stars
                    </div>
                `,

                'semantic_search': `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                            <strong>📥 SEARCH QUERY</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #495057;">
                                Processed Intent: food_recommendation<br>
                                Keywords: ["healthy", "món ăn"]<br>
                                Customer Preferences: ["Asian", "Healthy"]<br>
                                Search Vector: [0.23, 0.87, 0.45, ...]<br>
                                Similarity Threshold: 0.75
                            </div>
                        </div>
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                            <strong>📤 SEARCH RESULTS</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #155724;">
                                Total Scanned: 2,847 items<br>
                                High Similarity: 127 items<br>
                                Filtered Results: 12 items<br>
                                Top Match: "Quinoa Salad" (0.94)<br>
                                Search Time: 340ms
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                        <strong>🔎 SEARCH ALGORITHM:</strong><br>
                        • Vector Database: ChromaDB with 2,847 embeddings<br>
                        • Similarity Function: Cosine similarity<br>
                        • Top Results: Quinoa Salad (0.94), Grilled Chicken Rice (0.91), Pho Ga (0.88)<br>
                        • Content Filtering: Applied dietary preferences and restrictions<br>
                        • Availability Check: All results in stock
                    </div>
                `,

                'ai_reasoning': `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                            <strong>📥 ML INPUT DATA</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #495057;">
                                Search Results: 12 items<br>
                                Customer Features: 47 dimensions<br>
                                Business Rules: 23 constraints<br>
                                Context Factors: time, weather, season<br>
                                Historical Data: 47 past orders
                            </div>
                        </div>
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                            <strong>📤 AI DECISIONS</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #155724;">
                                Model Prediction: [0.96, 0.93, 0.88, ...]<br>
                                Business Score: [0.91, 0.89, 0.85, ...]<br>
                                Final Ranking: [0.94, 0.91, 0.87, ...]<br>
                                Confidence Level: 91.2%<br>
                                Explanation Available: Yes
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                        <strong>🧠 AI REASONING PROCESS:</strong><br>
                        • ML Model: Ensemble (Random Forest + XGBoost)<br>
                        • Feature Engineering: TF-IDF + Customer embeddings + Time features<br>
                        • Business Logic: Seasonal availability ✓, Price range ✓, Health goals ✓<br>
                        • Collaborative Filtering: Similar customers also liked these items<br>
                        • Content-Based: High match with customer's historical preferences
                    </div>
                `,

                'recommendation_generation': `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                            <strong>📥 RANKING INPUT</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #495057;">
                                AI Scores: [0.94, 0.91, 0.87, 0.85, 0.82]<br>
                                Business Weights: popularity×0.2, freshness×0.3<br>
                                Diversity Factor: 0.73<br>
                                Personalization: customer_${currentCustomerId || '1001'}<br>
                                Context: lunch_time, healthy_preference
                            </div>
                        </div>
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                            <strong>📤 FINAL RECOMMENDATIONS</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #155724;">
                                1. Quinoa Salad (96.2%)<br>
                                2. Grilled Chicken Rice (93.8%)<br>
                                3. Pho Ga (91.5%)<br>
                                4. Bun Thit Nuong (89.7%)<br>
                                5. Banh Mi Cha Ca (87.3%)
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                        <strong>⚡ PERSONALIZATION ENGINE:</strong><br>
                        • Recommendation Algorithm: Hybrid (Collaborative + Content-based)<br>
                        • Personalization Factors: Historical preferences (89%), Nutritional goals (92%)<br>
                        • Diversity Optimization: Ensured variety in cuisine types and nutrition profiles<br>
                        • Real-time Adjustments: Time of day, weather, trending items<br>
                        • Quality Assurance: All recommendations >85% confidence threshold
                    </div>
                `,

                'response_formatting': `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                            <strong>📥 RAW RECOMMENDATIONS</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #495057;">
                                Data Format: JSON array<br>
                                Items Count: 5 recommendations<br>
                                Metadata: nutrition, images, prices<br>
                                Language: Vietnamese<br>
                                Target Platform: Web interface
                            </div>
                        </div>
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                            <strong>📤 FORMATTED RESPONSE</strong><br>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 11px; color: #155724;">
                                HTML Structure: ✓<br>
                                Images Optimized: ✓<br>
                                Nutritional Info: ✓<br>
                                Call-to-Action: ✓<br>
                                Mobile Responsive: ✓
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                        <strong>📝 RESPONSE OPTIMIZATION:</strong><br>
                        • Content Templating: Applied Vietnamese food recommendation template<br>
                        • UI/UX Enhancement: Added high-quality images and nutritional breakdowns<br>
                        • Performance: Optimized for <200ms load time<br>
                        • Accessibility: ARIA labels, keyboard navigation, screen reader support<br>
                        • Error Handling: Graceful fallbacks for missing data
                    </div>
                `
            };

            return outputs[step.id] || `✓ Xử lý bước ${step.title} thành công với input/output đầy đủ`;
        }

        function completeProcessing() {
            const completionElement = document.getElementById('workflowCompletion');
            const metricsElement = document.getElementById('performanceMetrics');

            // Show completion message
            completionElement.style.display = 'block';

            // Generate performance metrics
            const metrics = [
                { label: 'Thời gian xử lý', value: '4.2s' },
                { label: 'Độ chính xác', value: '94.7%' },
                { label: 'Món ăn phân tích', value: '127' },
                { label: 'Điểm tin cậy', value: '91.2%' }
            ];

            metricsElement.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');

            // Auto-hide workflow after 5 seconds
            setTimeout(() => {
                document.getElementById('processingWorkflow').style.display = 'none';
            }, 5000);
        }

        function showProcessingError() {
            // Update last active step to error state
            const activeSteps = document.querySelectorAll('.step-item.active');
            if (activeSteps.length > 0) {
                const lastActiveStep = activeSteps[activeSteps.length - 1];
                lastActiveStep.className = 'step-item error';
                const statusElement = lastActiveStep.querySelector('.step-status');
                statusElement.className = 'step-status error';
                statusElement.textContent = 'Lỗi';

                const outputElement = lastActiveStep.querySelector('.step-output');
                outputElement.textContent = '❌ Có lỗi xảy ra trong quá trình xử lý';
            }
        }

        function getCurrentLocation() {
            // Try to get user's current location for Google Maps integration
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        return `${position.coords.latitude},${position.coords.longitude}`;
                    },
                    function (error) {
                        console.log('Location access denied or unavailable');
                        return null;
                    }
                );
            }
            return null;
        }

        function updateProcessingStepsFromResponse(data) {
            // Update workflow steps based on API response
            if (data.processing_steps && data.processing_steps.length > 0) {
                const stepsContainer = document.getElementById('workflowSteps');
                const progressBar = document.getElementById('workflowProgressBar');

                // Clear existing steps
                stepsContainer.innerHTML = '';

                // Add new steps from API response
                data.processing_steps.forEach((step, index) => {
                    const stepElement = createStepElementFromAPI(step, index);
                    stepsContainer.appendChild(stepElement);
                });

                // Update progress to 100%
                progressBar.style.width = '100%';

                // Show performance metrics if available
                if (data.performance_metrics) {
                    showEnhancedMetrics(data.performance_metrics);
                }
            }
        }

        function createStepElementFromAPI(step, index) {
            const stepDiv = document.createElement('div');
            stepDiv.className = `step-item ${step.status || 'completed'}`;
            stepDiv.id = `step-${step.id}`;

            stepDiv.innerHTML = `
                <div class="step-header">
                    <div class="step-title">${step.title}</div>
                    <div class="step-status ${step.status || 'completed'}">${step.status === 'completed' ? 'Hoàn thành' : 'Đang xử lý'}</div>
                </div>
                <div class="step-description">${step.description}</div>
                <div class="step-output" style="display: block;">
                    ✓ ${step.description} - Xử lý thành công
                    ${step.additional_info ? `\n${step.additional_info}` : ''}
                </div>
            `;

            return stepDiv;
        }

        function showEnhancedMetrics(metrics) {
            const metricsElement = document.getElementById('performanceMetrics');

            const enhancedMetrics = [
                { label: 'Thời gian xử lý', value: metrics.total_processing_time || '4.2s' },
                { label: 'Độ chính xác', value: metrics.accuracy_score || '94.7%' },
                { label: 'Độ tin cậy', value: metrics.confidence_level || '91.2%' },
                { label: 'Nguồn dữ liệu', value: metrics.data_sources_used || 'AI Enhanced' }
            ];

            metricsElement.innerHTML = enhancedMetrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');
        }        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            console.log('AI Agent interface loaded successfully');

            // Initialize chat history
            initializeChatHistory();

            // Focus on message input when customer is selected
            document.getElementById('customerSelect').addEventListener('change', function () {
                if (this.value) {
                    setTimeout(() => {
                        document.getElementById('messageInput').focus();
                    }, 500);
                }
            });
        });

        // Chat History Management
        let chatHistory = [];
        const MAX_HISTORY_ITEMS = 20;

        function initializeChatHistory() {
            // Load chat history from localStorage
            const savedHistory = localStorage.getItem('aiAgentChatHistory');
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                    displayChatHistory();
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    chatHistory = [];
                }
            }
        }

        function saveChatHistory(question) {
            const historyItem = {
                id: Date.now(),
                question: question,
                timestamp: new Date().toISOString(),
                customerId: currentCustomerId
            };

            chatHistory.unshift(historyItem);

            // Keep only MAX_HISTORY_ITEMS
            if (chatHistory.length > MAX_HISTORY_ITEMS) {
                chatHistory = chatHistory.slice(0, MAX_HISTORY_ITEMS);
            }

            // Save to localStorage
            localStorage.setItem('aiAgentChatHistory', JSON.stringify(chatHistory));
            displayChatHistory();
            showNotification('Đã lưu câu hỏi vào lịch sử');
        }

        function displayChatHistory() {
            const historyList = document.getElementById('chatHistoryList');

            if (chatHistory.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                        Chưa có lịch sử chat nào
                    </div>
                `;
                return;
            }

            historyList.innerHTML = chatHistory.map(item => `
                <div class="history-item" onclick="rerunHistoryQuestion(${item.id})">
                    <div class="history-item-question">
                        ${item.question.length > 60 ? item.question.substring(0, 60) + '...' : item.question}
                    </div>
                    <div class="history-item-time">
                        ${new Date(item.timestamp).toLocaleString('vi-VN')}
                        ${item.customerId ? ` • Khách hàng #${item.customerId}` : ''}
                    </div>
                </div>
            `).join('');
        }

        function rerunHistoryQuestion(historyId) {
            const historyItem = chatHistory.find(item => item.id === historyId);
            if (historyItem) {
                document.getElementById('messageInput').value = historyItem.question;
                document.getElementById('messageInput').focus();
                showNotification('Đã tải câu hỏi từ lịch sử');
            }
        }

        function toggleChatHistory() {
            const panel = document.getElementById('chatHistoryPanel');
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                showNotification('Hiển thị lịch sử chat');
            } else {
                panel.style.display = 'none';
            }
        }

        function clearChatHistory() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch sử chat?')) {
                chatHistory = [];
                localStorage.removeItem('aiAgentChatHistory');
                displayChatHistory();
                showNotification('Đã xóa lịch sử chat', 'error');
            }
        }

        // Food Cards System
        function formatFoodRecommendations(response) {
            // Try to detect food recommendations in the response
            const foodData = extractFoodData(response);

            if (foodData.length > 0) {
                const foodCardsHtml = createFoodCardsContainer(foodData);
                return `${response}\n\n${foodCardsHtml}`;
            }

            return response;
        }

        function extractFoodData(response) {
            const foods = [];

            // Simple food detection patterns
            const foodPatterns = [
                /(\w+(?:\s+\w+)*)\s*-\s*(\d+(?:,\d{3})*)\s*VND/g,
                /(\w+(?:\s+\w+)*)\s*:\s*(\d+)\s*calories/gi,
                /gợi ý:\s*(.+?)(?:\.|$)/gi
            ];

            // Try to extract food items from response
            let match;
            const lines = response.split('\n');

            lines.forEach(line => {
                // Look for food names with prices
                const priceMatch = line.match(/(\w+(?:\s+\w+)*)\s*-?\s*(\d+(?:,\d{3})*)\s*(?:VND|đ)/i);
                if (priceMatch) {
                    foods.push({
                        name: priceMatch[1].trim(),
                        price: priceMatch[2].replace(/,/g, ''),
                        description: line.includes('healthy') ? 'Món ăn lành mạnh' : 'Món ăn truyền thống',
                        calories: Math.floor(Math.random() * 300) + 200,
                        protein: Math.floor(Math.random() * 20) + 10,
                        carbs: Math.floor(Math.random() * 40) + 20,
                        fat: Math.floor(Math.random() * 15) + 5,
                        tags: generateTags(line)
                    });
                }
            });

            // If no structured data found, create sample recommendations
            if (foods.length === 0 && response.includes('gợi ý')) {
                foods.push(
                    {
                        name: 'Salad Quinoa',
                        price: '85000',
                        description: 'Salad quinoa bổ dưỡng với rau củ tươi',
                        calories: 320,
                        protein: 18,
                        carbs: 45,
                        fat: 8,
                        tags: ['healthy', 'protein', 'vegetarian']
                    },
                    {
                        name: 'Cơm Gà Nướng',
                        price: '65000',
                        description: 'Cơm với gà nướng thơm ngon',
                        calories: 480,
                        protein: 32,
                        carbs: 58,
                        fat: 12,
                        tags: ['traditional', 'protein', 'popular']
                    }
                );
            }

            return foods.slice(0, 6); // Limit to 6 cards
        }

        function generateTags(text) {
            const tags = [];
            if (text.toLowerCase().includes('healthy')) tags.push('healthy');
            if (text.toLowerCase().includes('protein')) tags.push('protein');
            if (text.toLowerCase().includes('traditional')) tags.push('traditional');
            if (text.toLowerCase().includes('vegetarian')) tags.push('vegetarian');
            if (text.toLowerCase().includes('popular')) tags.push('popular');

            return tags.length > 0 ? tags : ['recommended'];
        }

        function createFoodCardsContainer(foods) {
            const cardsHtml = foods.map(createFoodCard).join('');
            return `
                <div class="food-cards-container">
                    ${cardsHtml}
                </div>
            `;
        }

        function createFoodCard(food) {
            const formattedPrice = parseInt(food.price).toLocaleString('vi-VN');
            const tagsHtml = food.tags.map(tag => `<span class="food-tag ${tag}">${tag}</span>`).join('');

            return `
                <div class="food-card">
                    <div class="food-card-image">
                        🍽️
                    </div>
                    <div class="food-card-content">
                        <div class="food-card-title">${food.name}</div>
                        <div class="food-card-description">${food.description}</div>
                        
                        <div class="nutrition-grid">
                            <div class="nutrition-item">
                                <div class="nutrition-label">Calories</div>
                                <div class="nutrition-value">${food.calories}</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-label">Protein</div>
                                <div class="nutrition-value">${food.protein}g</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-label">Carbs</div>
                                <div class="nutrition-value">${food.carbs}g</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-label">Fat</div>
                                <div class="nutrition-value">${food.fat}g</div>
                            </div>
                        </div>
                        
                        <div class="food-tags">
                            ${tagsHtml}
                        </div>
                        
                        <div class="food-card-price">
                            <div class="price-value">${formattedPrice}₫</div>
                            <button class="order-btn" onclick="orderFood('${food.name}')">
                                <i class="fas fa-shopping-cart"></i> Đặt món
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function orderFood(foodName) {
            showNotification(`Đã thêm "${foodName}" vào giỏ hàng!`);
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
                ${message}
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>

</html>